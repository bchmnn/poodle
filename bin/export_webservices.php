<?php

/**
 * CLI script to export web service JSON
 *
 * @package   moodle-api-gen
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author    Joshua Pare
 *
 * This script is part of a custom package for autogenerated Moodle clients and
 * documentation.
 *
 * Repository: https://github.com/joshuapare/moodle-api-gen
 */

define('CLI_SCRIPT', true);

use core_external\external_api;

require(__DIR__.'/../../config.php');
require_once($CFG->libdir.'/clilib.php');
require_once($CFG->dirroot.'/webservice/lib.php');
require_once($CFG->libdir.'/adminlib.php');

list($options, $unrecognized) = cli_get_params(
    [
        'file' => false,
        'help' => false
    ],
    [
        'f' => 'file',
        'h' => 'help'
    ]
);

if ($unrecognized) {
    cli_error(get_string('cliunknowoption', 'admin', implode("\n  ", $unrecognized)));
}

if ($options['help']) {
    $help = "Export web service JSON.

Options:
-f, --file     Optional: Output to a specified file instead of stdout.
-h, --help     Print out this help.

Example:
\$sudo -u www-data /usr/bin/php admin/cli/export_webservices.php --file=output.json

";
    echo $help;
    exit(0);
}

// get all the function descriptions programatically
$functions = $DB->get_records('external_functions', [], 'name');
$functiondescs = [];
foreach ($functions as $function) {
    try {
        $functiondescs[$function->name] = external_api::external_function_info($function);
    } catch (Throwable $exception) {
        cli_error($exception->getMessage());
    }
}

$formatted = json_encode($functiondescs, JSON_PRETTY_PRINT);

if ($options['file']) {
    file_put_contents($options['file'], $formatted);
    cli_writeln("Output written to {$options['file']}");
} else {
    echo $formatted;
}

exit(0);
